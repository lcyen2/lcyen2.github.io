<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<style>
		html {
			font-family: 'Arial', sans-serif;
		}
				
		.title {
			margin-top: 40px;
			margin-left: 60px;
			text-align: left;
		}
		
		input {
			margin-right: 10px;
		}
		
		.form-check-inline {
			font-size: 0.8em;
			color: #0006A6;
		}
	</style>
</head>
  
<body>
	<div class ='container-fluid'>
		<div class='row'>
			<div id='chart'>
				<div class='title'>
					<p><h3>Telecommunications Indices during the 4G Era (2008-2017)</h3>
						   Year-over-Year Trends and Head-to-Head Comparisons among the Group of Twenty (G-20) Countries</p>
					<hr>
					<p><div class='form-check-inline'>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						Q1: How many people have access to the Internet?&nbsp;&nbsp;&nbsp;&nbsp;
						<label class='form-check-label'>
							<input type='radio' name='kpi' value='1' checked>Overall Internet Penetration
						</label>
					</div></p>
					<div class='form-check-inline'>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						Q2: What do people use for communications?&nbsp;&nbsp;&nbsp;&nbsp;
						<label class='form-check-label'>
							<input type='radio' name='kpi' value='2'>Fixed Broadband (Fiber/Cable)
						</label>
					</div>
					<div class='form-check-inline'>
						<label class='form-check-label'>
							<input type='radio' name='kpi' value='3'>Fixed Telephone (ADSL/Dial-up)
						</label>
					</div>
					<div class='form-check-inline'>
						<label class='form-check-label'>
							<input type='radio' name='kpi' value='4'>Mobile Smartphone (Cellular)
						</label>
					</div>
				</div>
			</div>
		</div>
	</div>
		
	<script>
	
    var margin = {top: 80, right: 200, bottom: 40, left: 80}
    var width = 1400 - margin.left - margin.right
    var height = 500 - margin.top - margin.bottom

    var parseYear = d3.timeParse("%Y-%m")

    var mice
	var glines
	var tooltip

    var code = ["ARG: Argentina",
				"AUS: Australia",
				"BRA: Brazil",
				"CAN: Canada",
				"CHN: China",
				"EUU: European Union",
				"FRA: France",
				"DEU: Germany",
				"IND: India",
				"IND: Indonesia",
				"ITA: Italy",
				"JPN: Japan",
				"KOR: South Korea",
				"MEX: Mexico",
				"RUS: Russia",
				"SAU: Saudi Arabia",
				"ZAF: South Africa",
				"TUR: Turkey",
				"GBR: United Kingdom",
				"USA: United States"]
    
	var color = d3.scaleOrdinal()
				.domain(code)
				.range(["#E6194B", "#3CB44B", "#FFE119", "#4363D8", "#F58231",
						"#911EB4", "#46F0F0", "#F032E6", "#BCF60C", "#FABEBE",
						"#008080", "#E6BEFF", "#9A6324", "#FFFAC8", "#800000",
						"#AAFFC3", "#808000", "#FFD8B1", "#000075", "#808080"])

	var bgcolor = "#A9A9A9"
		
    d3.csv("https://lcyen2.github.io/WDIDataG20.csv", data => {

        var g8 = data.map((d,i) => {
					return {
						year: parseYear(d.time),
						country: d.country,
						kpi: +d.kpi,
						wdi: +d.wdi	}
					})

        var xScale = d3.scaleTime().domain(d3.extent(g8, d=>d.year)).range([0, width])
		var yScale = d3.scaleLinear().domain([0, d3.max(g8, d=>d.wdi)]).range([height, 0]);

        var svg = d3.select("#chart")
					.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
					.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var xAxis = d3.axisBottom(xScale).ticks(d3.timeYear)
        var yAxis = d3.axisLeft(yScale).ticks(10,"s").tickSize(-width)

        svg.append("g")
			.attr("transform", `translate(0, ${height})`)
			.call(xAxis)
			.call(g => {
				g.selectAll("text")
					.attr("fill", bgcolor)
				g.selectAll("line")
					.attr("stroke", bgcolor)
				g.select(".domain")
					.attr("stroke", bgcolor)
				})
				
        svg.append("g")
			.call(yAxis)
			.call(g => {
				g.selectAll("text")
					.style("text-anchor", "middle")
					.attr("x", -20)
					.attr("fill", bgcolor)
				g.selectAll("line")
					.attr("stroke", bgcolor)
					.attr("stroke-dasharray", "2,2")
					.attr("stroke-width", 0.8)
					.attr("opacity", 0.4)
				g.select(".domain")
					.remove()
				})
			.append("text")
				.attr("x", 40)
				.attr("y", -20)
				.attr("fill", bgcolor)
				.text("Adoptation (%)")

		var legend = svg.append("g")
							.attr("transform", "translate(" + (width + 60) + "," + 0 + ")")
						.selectAll(".legend").data(code).enter().append("g")
							.attr("transform", function(d,i) { return "translate(0," + i * 20 + ")" })

        legend.append("circle")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("r", 6)
            .style("fill", d=>color(d))

        legend.append("text")
            .attr("x", 12)
            .attr("y", 5)
            .style("fill", bgcolor)
            .style("font-size", 12)
            .text(d=>d)

        var line = d3.line()
					.x(d => xScale(d.year))
					.y(d => yScale(d.wdi))

        createChart(1)

        d3.selectAll(("input[name='kpi']")).on("change", function() { updateChart(this.value) })

        function updateChart(kpi) {

			var newG8 = g8.filter(d => d.kpi == parseInt(kpi))
			var nestG8 = d3.nest()
				.key(d => d.country)
				.entries(newG8)

			glines.select(".line") //select line path within line-group (which represents a vehicle category), then bind new data 
				.data(nestG8)
				.transition().duration(1000)
				.attr("d", function(d) { return line(d.values) })

			mice.selectAll(".mouse-per-line")
				.data(nestG8)

			mice.on("mousemove", function() { 
				var mouse = d3.mouse(this)
				updateTooltip(mouse, nestG8)
				})
			}

        function createChart(kpi) {

			var newG8 = g8.filter(d => d.kpi == parseInt(kpi))
			var nestG8 = d3.nest()
				.key(d => d.country)
				.entries(newG8)

			var lines = svg.append("g")
			
			glines = lines.selectAll(".line-group")
				.data(nestG8).enter().append("g")
				.attr("class", "line-group")

			glines.append("path")
				.attr("class", "line")  
				.attr("d", d => line(d.values))
				.style("stroke", (d,i) => color(i))
				.style("stroke-width", "2px")
				.style("fill", "none")
				.style("opacity", 1)

			tooltip = d3.select("#chart").append("div")
				.attr("id", "tooltip")
				.style("position", "absolute")
				.style("background-color", "#F3F3F3")
				.style("display", "none")
				.style("padding", 6)

			mice = svg.append("g")
				.attr("class", "mouse-over-effects");

			mice.append("path")
				.attr("class", "mouse-line")
				.style("stroke-width", "1px")
				.style("stroke", bgcolor)
				.style("opacity", 0);

			var lines = document.getElementsByClassName("line");

			var mousePerLine = mice.selectAll('.mouse-per-line')
				.data(nestG8).enter().append("g")
				.attr("class", "mouse-per-line");

			mousePerLine.append("circle")
				.attr("r", 4)
				.style("stroke", function(d) { return color(d.key) })
				.style("stroke-width", "2px")
				.style("fill", "none")
				.style("opacity", "0");

			mice.append("svg:rect")
				.attr("width", width) 
				.attr("height", height)
				.attr("fill", "none")
				.attr("pointer-events", "all")
				.on("mouseout", function() {
					d3.select(".mouse-line").style("opacity", 0);
					d3.selectAll(".mouse-per-line circle").style("opacity", 0);
					d3.selectAll(".mouse-per-line text").style("opacity", 0);
					d3.selectAll("#tooltip").style("display", "none")
					})
				.on("mouseover", function() {
					d3.select(".mouse-line").style("opacity", 1);
					d3.selectAll(".mouse-per-line circle").style("opacity", 1);
					d3.selectAll("#tooltip").style("display", "block")
					})
				.on("mousemove", function() { 
					var mouse = d3.mouse(this)
					d3.selectAll(".mouse-per-line")
						.attr("transform", function(d,i) {
							var xDate = xScale.invert(mouse[0])  // use 'invert' to get year corresponding to distance from mouse position relative to svg
							var bisect = d3.bisector(function(d) { return d.year; }).left  // retrieve row index of year on parsed csv
							var idx = bisect(d.values, xDate);
							d3.select(".mouse-line")
								.attr("d", function() {
									var data = "M" + xScale(d.values[idx].year) + "," + (height);
										data += " " + xScale(d.values[idx].year) + "," + 0;
									return data;
									});
							return "translate(" + xScale(d.values[idx].year) + "," + yScale(d.values[idx].wdi) + ")";
							});
					updateTooltip(mouse, nestG8)
					})
			}

		function updateTooltip(mouse, nestG8) {
		
			sortG8 = []
			
			nestG8.map(d => {
				var xDate = xScale.invert(mouse[0])
				var bisect = d3.bisector(function(d) { return d.year; }).left
				var idx = bisect(d.values, xDate)
				sortG8.push({key: d.values[idx].country,
							wdi: d.values[idx].wdi,
							kpi: d.values[idx].kpi, 
							year: d.values[idx].year.getFullYear()})
				})

			sortG8.sort(function(x,y) { return d3.descending(x.wdi,y.wdi); })

			var sorted = sortG8.map(d => d.key)

			var nested = nestG8.slice().sort(function(a,b) {
				return sorted.indexOf(a.key) - sorted.indexOf(b.key)
				})
			
			tooltip.html("YEAR " + sortG8[0].year)
					.style("display", "block")
					.style("left", d3.event.pageX + 20)
					.style("top", d3.event.pageY - 20)
					.style("font-size", 12)
				.selectAll().data(nested).enter().append("div")
					.style("color", d => { return color(d.key) })
					.style("font-size", 10)
				.html(d => {
					var xDate = xScale.invert(mouse[0])
					var bisect = d3.bisector(function(d) { return d.year; }).left
					var idx = bisect(d.values, xDate)
					return d.key + ": " + d.values[idx].wdi.toString() + " %"
					})
			}
    })

    </script>
</body>
</html>
